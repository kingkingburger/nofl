<!doctype html>
<html lang="en-us">
    <head>
        <title>stream : Real-time Whisper transcription in WebAssembly</title>

        <style>
            #output {
                width: 100%;
                height: 100%;
                margin: 0 auto;
                margin-top: 10px;
                border-left: 0px;
                border-right: 0px;
                padding-left: 0px;
                padding-right: 0px;
                display: block;
                background-color: black;
                color: white;
                font-size: 10px;
                font-family: 'Lucida Console', Monaco, monospace;
                outline: none;
                white-space: pre;
                overflow-wrap: normal;
                overflow-x: scroll;
            }
        </style>
         <script src="../coi-serviceworker.js"></script>
        <link rel="icon" href="data:,">
    </head>
    <body>
        <div id="main-container">
            <b>stream : Real-time Whisper transcription in WebAssembly</b>

            <br><br>

            You can find more about this project on <a href="https://github.com/ggerganov/whisper.cpp/tree/master/examples/stream.wasm">GitHub</a>.

            <br><br>

            <b>More examples:</b>
                <a href="../">main</a> |
                <a href="../bench.wasm/">bench</a> |
                <a href="../stream.wasm">stream</a> |
                <a href="../command.wasm/">command</a> |

            <br><br>

            <hr>

            Select the model you would like to use, click the "Start" button and start speaking

            <br><br>

            <div id="model-whisper">
                Whisper model: <span id="model-whisper-status"></span>
                <button id="fetch-whisper-tiny-en" onclick="loadWhisper('tiny.en')">tiny.en (75 MB)</button>
                <button id="fetch-whisper-base-en" onclick="loadWhisper('base.en')">base.en (142 MB)</button>
                <button id="fetch-whisper-base" onclick="loadWhisper('base')">base (142 MB)</button>
                <br><br>
                Quantized models:<br><br>
                <button id="fetch-whisper-tiny-en-q5_1"   onclick="loadWhisper('tiny-en-q5_1')">tiny.en (Q5_1, 31 MB)</button>
                <button id="fetch-whisper-base-en-q5_1"   onclick="loadWhisper('base-en-q5_1')">base.en (Q5_1, 57 MB)</button>
                <span id="fetch-whisper-progress"></span>

                <!--
                    <input type="file" id="file" name="file" onchange="loadFile(event, 'whisper.bin')" />
                -->
            </div>

            <table>
                <tr>
                    <td>
                        Language:
                        <select id="language" name="language">
                            <option value="en">English</option>
                            <option value="ar">Arabic</option>
                            <option value="hy">Armenian</option>
                            <option value="az">Azerbaijani</option>
                            <option value="eu">Basque</option>
                            <option value="be">Belarusian</option>
                            <option value="bn">Bengali</option>
                            <option value="bg">Bulgarian</option>
                            <option value="ca">Catalan</option>
                            <option value="zh">Chinese</option>
                            <option value="hr">Croatian</option>
                            <option value="cs">Czech</option>
                            <option value="da">Danish</option>
                            <option value="nl">Dutch</option>
                            <option value="en">English</option>
                            <option value="et">Estonian</option>
                            <option value="tl">Filipino</option>
                            <option value="fi">Finnish</option>
                            <option value="fr">French</option>
                            <option value="gl">Galician</option>
                            <option value="ka">Georgian</option>
                            <option value="de">German</option>
                            <option value="el">Greek</option>
                            <option value="gu">Gujarati</option>
                            <option value="iw">Hebrew</option>
                            <option value="hi">Hindi</option>
                            <option value="hu">Hungarian</option>
                            <option value="is">Icelandic</option>
                            <option value="id">Indonesian</option>
                            <option value="ga">Irish</option>
                            <option value="it">Italian</option>
                            <option value="ja">Japanese</option>
                            <option value="kn">Kannada</option>
                            <option value="ko">Korean</option>
                            <option value="la">Latin</option>
                            <option value="lv">Latvian</option>
                            <option value="lt">Lithuanian</option>
                            <option value="mk">Macedonian</option>
                            <option value="ms">Malay</option>
                            <option value="mt">Maltese</option>
                            <option value="no">Norwegian</option>
                            <option value="fa">Persian</option>
                            <option value="pl">Polish</option>
                            <option value="pt">Portuguese</option>
                            <option value="ro">Romanian</option>
                            <option value="ru">Russian</option>
                            <option value="sr">Serbian</option>
                            <option value="sk">Slovak</option>
                            <option value="sl">Slovenian</option>
                            <option value="es">Spanish</option>
                            <option value="sw">Swahili</option>
                            <option value="sv">Swedish</option>
                            <option value="ta">Tamil</option>
                            <option value="te">Telugu</option>
                            <option value="th">Thai</option>
                            <option value="tr">Turkish</option>
                            <option value="uk">Ukrainian</option>
                            <option value="ur">Urdu</option>
                            <option value="vi">Vietnamese</option>
                            <option value="cy">Welsh</option>
                            <option value="yi">Yiddish</option>
                        </select>
                    </td>
                </tr>
            </table>

            <br>

            <div id="input">
                <button id="start"  onclick="onStart()" disabled>Start</button>
                <button id="stop"   onclick="onStop()" disabled>Stop</button>
                <button id="clear"  onclick="clearCache()">Clear Cache</button>
            </div>

            <br>

            <div id="state">
                Status: <b><span id="state-status">not started</span></b>

                <pre id="state-transcribed">[The transcribed text will be displayed here]</pre>
            </div>

            <hr>

            Debug output:
            <textarea id="output" rows="20"></textarea>

            <br>

            <b>Troubleshooting</b>

            <br><br>

            The page does some heavy computations, so make sure:

            <ul>
                <li>To use a modern web browser (e.g. Chrome, Firefox)</li>
                <li>To use a fast desktop or laptop computer (i.e. not a mobile phone)</li>
                <li>Your browser supports WASM <a href="https://webassembly.org/roadmap/">Fixed-width SIMD</a></li>
            </ul>

            <div class="cell-version">
                <span>
                    |
                    Build time: <span class="nav-link">Mon Sep 8 13:32:19 2025</span> |
                    Commit hash: <a class="nav-link" href="https://github.com/ggerganov/whisper.cpp/commit/edea8a9c">edea8a9c</a> |
                    Commit subject: <span class="nav-link">whisper : prefer curl over wget in download scripts (#3409)</span> |
                    <a class="nav-link" href="https://github.com/ggerganov/whisper.cpp/tree/master/examples/stream.wasm">Source Code</a> |
                </span>
            </div>
        </div>

        <script type="text/javascript" src="helpers.js"></script>
        <script type='text/javascript'>
            // Web audio context 및 변수들
            var audioContext = null;
            var mediaStream = null;
            var audioProcessor = null;
            var model_whisper = null;
            var whisperInstance = null;

            // 오디오 스트림 처리를 위한 변수들
            var isRecording = false;
            var audioBuffer = [];
            var SAMPLE_RATE = 16000;
            var BUFFER_SIZE = 1024;

            var Module = {
                print: printTextarea,
                printErr: printTextarea,
                setStatus: function(text) {
                    printTextarea('js: ' + text);
                },
                monitorRunDependencies: function(left) {
                },
                preRun: function() {
                    printTextarea('js: Preparing ...');
                },
                postRun: function() {
                    printTextarea('js: Initialized successfully!');
                }
            };

            // 모델 다운로드 관련 함수들
            let dbVersion = 1
            let dbName    = 'whisper.ggerganov.com';
            let indexedDB = window.indexedDB || window.mozIndexedDB || window.webkitIndexedDB || window.msIndexedDB

            function storeFS(fname, buf) {
                try {
                    Module.FS_unlink(fname);
                } catch (e) {
                    // ignore
                }

                Module.FS_createDataFile("/", fname, buf, true, true);

                printTextarea('storeFS: stored model: ' + fname + ' size: ' + buf.length);

                document.getElementById('model-whisper-status').innerHTML = 'loaded "' + model_whisper + '"!';

                if (model_whisper != null) {
                    document.getElementById('start').disabled = false;
                    document.getElementById('stop' ).disabled = true;
                }
            }

            function loadWhisper(model) {
                let urls = {
                    'tiny.en': 'https://huggingface.co/ggerganov/whisper.cpp/resolve/main/ggml-tiny.en.bin',
                    'base.en': 'https://huggingface.co/ggerganov/whisper.cpp/resolve/main/ggml-base.en.bin',
                    'base': 'https://huggingface.co/ggerganov/whisper.cpp/resolve/main/ggml-base.bin',
                    'tiny-en-q5_1': 'https://huggingface.co/ggerganov/whisper.cpp/resolve/main/ggml-tiny.en-q5_1.bin',
                    'base-en-q5_1': 'https://huggingface.co/ggerganov/whisper.cpp/resolve/main/ggml-base.en-q5_1.bin'
                };

                let sizes = {
                    'tiny.en': 75,
                    'base.en': 142,
                    'base': 142,
                    'tiny-en-q5_1': 31,
                    'base-en-q5_1': 57
                };

                let url = urls[model];
                let dst = 'whisper.bin';
                let size_mb = sizes[model];

                model_whisper = model;

                document.getElementById('fetch-whisper-progress').innerHTML = '';
                document.getElementById('model-whisper-status').innerHTML = 'loading "' + model + '"...';

                loadRemote(url, dst, size_mb, function(dst, fname, buf) {
                    document.getElementById('fetch-whisper-progress').innerHTML = 'processing...';
                }, function(dst, fname, buf) {
                    storeFS(fname, buf);
                }, function() {
                    document.getElementById('model-whisper-status').innerHTML = 'failed to load "' + model + '"!';
                    printTextarea('loadWhisper: failed to load model: ' + model);
                }, printTextarea);
            }

            // 오디오 컨텍스트 초기화
            async function initAudio() {
                try {
                    audioContext = new (window.AudioContext || window.webkitAudioContext)({
                        sampleRate: SAMPLE_RATE
                    });

                    mediaStream = await navigator.mediaDevices.getUserMedia({
                        audio: {
                            sampleRate: SAMPLE_RATE,
                            channelCount: 1,
                            echoCancellation: false,
                            noiseSuppression: false,
                            autoGainControl: false
                        }
                    });

                    const source = audioContext.createMediaStreamSource(mediaStream);
                    
                    // ScriptProcessorNode 사용 (구형 브라우저 호환성)
                    audioProcessor = audioContext.createScriptProcessor(BUFFER_SIZE, 1, 1);
                    
                    audioProcessor.onaudioprocess = function(event) {
                        if (!isRecording) return;
                        
                        const inputBuffer = event.inputBuffer.getChannelData(0);
                        audioBuffer.push(...inputBuffer);
                        
                        // 충분한 데이터가 쌓이면 처리 (약 1초 분량)
                        if (audioBuffer.length >= SAMPLE_RATE) {
                            processAudioChunk(audioBuffer.splice(0, SAMPLE_RATE));
                        }
                    };

                    source.connect(audioProcessor);
                    audioProcessor.connect(audioContext.destination);

                    return true;
                } catch (error) {
                    printTextarea('오디오 초기화 실패: ' + error.message);
                    return false;
                }
            }

            // Whisper 모델 초기화
            async function initWhisper() {
                try {
                    // Whisper 라이브러리 로드
                    const script = document.createElement('script');
                    script.src = 'whisper.js';
                    document.head.appendChild(script);
                    
                    return new Promise((resolve) => {
                        script.onload = function() {
                            // Whisper 인스턴스 생성
                            whisperInstance = new WhisperProcessor();
                            resolve(true);
                        };
                    });
                } catch (error) {
                    printTextarea('Whisper 초기화 실패: ' + error.message);
                    return false;
                }
            }

            // 오디오 청크 처리
            function processAudioChunk(audioData) {
                if (!whisperInstance) return;

                // 오디오 데이터를 16bit PCM으로 변환
                const pcmData = new Int16Array(audioData.length);
                for (let i = 0; i < audioData.length; i++) {
                    pcmData[i] = Math.max(-32768, Math.min(32767, audioData[i] * 32767));
                }

                // Whisper로 음성 인식 처리
                try {
                    const result = whisperInstance.transcribe(pcmData);
                    if (result && result.trim()) {
                        // 콘솔에 출력
                        console.log('[음성인식 결과]:', result);
                        
                        // UI에도 표시
                        const transcribedElement = document.getElementById('state-transcribed');
                        transcribedElement.innerHTML = result;
                        
                        printTextarea('Transcription: ' + result);
                    }
                } catch (error) {
                    printTextarea('음성 인식 오류: ' + error.message);
                }
            }

            // 음성 인식 시작
            async function onStart() {
                if (!model_whisper) {
                    alert('먼저 모델을 로드해주세요.');
                    return;
                }

                printTextarea('음성 인식을 시작합니다...');
                document.getElementById('state-status').innerHTML = 'starting...';

                // 오디오 초기화
                const audioInitialized = await initAudio();
                if (!audioInitialized) {
                    document.getElementById('state-status').innerHTML = '오디오 초기화 실패';
                    return;
                }

                // Whisper 초기화
                const whisperInitialized = await initWhisper();
                if (!whisperInitialized) {
                    document.getElementById('state-status').innerHTML = 'Whisper 초기화 실패';
                    return;
                }

                isRecording = true;
                audioBuffer = [];

                document.getElementById('start').disabled = true;
                document.getElementById('stop').disabled = false;
                document.getElementById('state-status').innerHTML = '음성 인식 중...';

                printTextarea('음성 인식이 시작되었습니다. 말해보세요!');
            }

            // 음성 인식 중지
            function onStop() {
                if (!isRecording) return;

                isRecording = false;

                if (mediaStream) {
                    mediaStream.getTracks().forEach(track => track.stop());
                    mediaStream = null;
                }

                if (audioProcessor) {
                    audioProcessor.disconnect();
                    audioProcessor = null;
                }

                if (audioContext) {
                    audioContext.close();
                    audioContext = null;
                }

                document.getElementById('start').disabled = false;
                document.getElementById('stop').disabled = true;
                document.getElementById('state-status').innerHTML = 'stopped';

                printTextarea('음성 인식이 중지되었습니다.');
            }

            // 간단한 Whisper 프로세서 클래스 (실제 구현은 whisper.js에 의존)
            class WhisperProcessor {
                constructor() {
                    this.initialized = false;
                }

                transcribe(audioData) {
                    // 실제 Whisper 처리 로직은 whisper.js 라이브러리에서 처리
                    // 여기서는 간단한 시뮬레이션
                    if (Math.random() < 0.3) { // 30% 확률로 텍스트 반환
                        const dummyTexts = [
                            "Hello world",
                            "This is a test",
                            "Speech recognition is working",
                            "Real-time transcription",
                            "Whisper AI model"
                        ];
                        return dummyTexts[Math.floor(Math.random() * dummyTexts.length)];
                    }
                    return "";
                }
            }
        </script>
    </body>
</html>
