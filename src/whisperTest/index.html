<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>Whisper.cpp 실시간 음성 인식</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      padding: 2em;
      max-width: 1200px;
      margin: 0 auto;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      color: white;
    }

    .container {
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
      border-radius: 20px;
      padding: 2em;
      box-shadow: 0 8px 32px rgba(31, 38, 135, 0.37);
      border: 1px solid rgba(255, 255, 255, 0.18);
    }

    h1 {
      text-align: center;
      margin-bottom: 2em;
      font-size: 2.5em;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
    }

    .section {
      margin-bottom: 2em;
      padding: 1.5em;
      background: rgba(255, 255, 255, 0.05);
      border-radius: 15px;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .section h2 {
      margin-top: 0;
      color: #fff;
      font-size: 1.5em;
    }

    select, button {
      padding: 12px 20px;
      border: none;
      border-radius: 10px;
      font-size: 16px;
      margin: 5px;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    select {
      background: rgba(255, 255, 255, 0.9);
      color: #333;
      min-width: 300px;
    }

    button {
      background: linear-gradient(45deg, #FF6B6B, #4ECDC4);
      color: white;
      font-weight: bold;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    button:hover:not(:disabled) {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(0,0,0,0.2);
    }

    button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }

    #progress-container {
      margin-top: 1em;
      background: rgba(255, 255, 255, 0.1);
      padding: 1em;
      border-radius: 10px;
    }

    #progress-bar {
      width: 100%;
      height: 30px;
      border-radius: 15px;
      background: rgba(255, 255, 255, 0.2);
    }

    #progress-bar::-webkit-progress-bar {
      border-radius: 15px;
      background: rgba(255, 255, 255, 0.2);
    }

    #progress-bar::-webkit-progress-value {
      border-radius: 15px;
      background: linear-gradient(90deg, #4ECDC4, #44A08D);
    }

    .recording-controls {
      display: flex;
      gap: 1em;
      justify-content: center;
      align-items: center;
      flex-wrap: wrap;
    }

    .audio-level-container {
      margin: 1em 0;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 10px;
      height: 20px;
      overflow: hidden;
    }

    #audio-level {
      height: 100%;
      background: linear-gradient(90deg, #4ECDC4, #FF6B6B);
      width: 0%;
      transition: width 0.1s ease;
    }

    #transcription {
      background: rgba(0, 0, 0, 0.2);
      border-radius: 10px;
      padding: 1.5em;
      max-height: 400px;
      overflow-y: auto;
      font-family: 'Monaco', 'Menlo', monospace;
      font-size: 14px;
      line-height: 1.6;
    }

    .transcription-item {
      margin-bottom: 1em;
      padding: 10px;
      background: rgba(255, 255, 255, 0.05);
      border-radius: 8px;
      border-left: 4px solid #4ECDC4;
    }

    .transcription-item strong {
      color: #4ECDC4;
    }

    #status {
      font-weight: bold;
      padding: 10px;
      border-radius: 5px;
      background: rgba(255, 255, 255, 0.1);
      display: inline-block;
      margin-top: 10px;
    }

    .status-container {
      text-align: center;
    }

    @keyframes pulse {
      0% { opacity: 1; }
      50% { opacity: 0.5; }
      100% { opacity: 1; }
    }

    .recording {
      animation: pulse 2s infinite;
    }
  </style>
</head>
<body>
<div class="container">
  <h1>🎤 Whisper.cpp 실시간 음성 인식</h1>

  <div class="section" style="background: rgba(255, 255, 255, 0.1); padding: 1em; border-radius: 10px; margin-bottom: 1em;">
    <h3 style="margin-top: 0; color: #4ECDC4;">🔧 설치 및 사용 안내</h3>
    <div style="font-size: 14px; line-height: 1.6;">
      <div style="background: rgba(0,0,0,0.2); padding: 1em; border-radius: 8px; margin-bottom: 1em;">
        <p style="margin: 0; color: #4ECDC4;"><strong>📋 whisper.cpp 빌드 및 실행 방법:</strong></p>
        <pre style="font-size: 12px; overflow-x: auto; margin: 0.5em 0; color: #ccc;">
# 1. whisper.cpp 클론 및 빌드
git clone https://github.com/ggml-org/whisper.cpp
cd whisper.cpp
mkdir build-em && cd build-em
emcmake cmake ..
make -j

# 2. 서버 실행 (whisper.cpp/examples 폴더에서)
python3 server.py

# 3. 브라우저에서 접속
# http://localhost:8000/whisper.cpp/</pre>
      </div>

      <p><strong>🌐 로컬 서버 없이 사용:</strong></p>
      <ul style="margin: 0.5em 0; padding-left: 1.5em;">
        <li>CDN에서 자동으로 WASM 파일을 로드합니다</li>
        <li>네트워크 연결이 필요합니다</li>
        <li>로컬 서버보다 느릴 수 있습니다</li>
      </ul>

      <p><strong>⚙️ 시스템 요구사항:</strong></p>
      <ul style="margin: 0.5em 0; padding-left: 1.5em;">
        <li>WASM SIMD 지원 브라우저 (Chrome 권장)</li>
        <li>SharedArrayBuffer 지원 (HTTPS 또는 localhost 필요)</li>
        <li>최소 2GB RAM (small 모델 사용 시)</li>
      </ul>

      <p style="margin-bottom: 0;"><strong>📊 지원 모델:</strong> tiny (39MB), base (74MB), small (244MB) - 최대 120초 오디오</p>
    </div>
  </div>

  <div class="section">
    <h2>📥 모델 다운로드</h2>
    <div style="margin-bottom: 1em;">
      <label for="model-select">모델 선택 (한국어 지원):</label><br>
      <select id="model-select"></select>
    </div>

    <button id="download-btn">선택한 모델 다운로드</button>

    <div id="progress-container" style="display: none;">
      <p id="progress-text">다운로드 중...</p>
      <progress id="progress-bar" value="0" max="100"></progress>
    </div>
  </div>

  <div class="section">
    <h2>🎙️ 음성 인식</h2>
    <div class="recording-controls">
      <button id="start-recording" disabled>🔴 녹음 시작</button>
      <button id="stop-recording" disabled>⏹️ 녹음 중지</button>
    </div>

    <div class="audio-level-container">
      <div id="audio-level"></div>
    </div>

    <p style="text-align: center; font-size: 14px; opacity: 0.8;">
      📌 팁: 명확하게 한국어로 말해보세요. 실시간으로 텍스트가 나타납니다.
    </p>
  </div>

  <div class="section">
    <h2>📝 인식 결과</h2>
    <div id="transcription">
      <p style="text-align: center; opacity: 0.6;">음성 인식 결과가 여기에 실시간으로 표시됩니다...</p>
    </div>
  </div>

  <div class="status-container">
    <p>🔥 상태: <span id="status">대기 중</span></p>
  </div>
</div>

<script>
  // whisper.cpp WASM 모듈 전역 설정
  var Module = {
    onRuntimeInitialized: function() {
      console.log('Whisper WASM 모듈이 성공적으로 초기화되었습니다.');
      Module.ready = true;

      // 상태 업데이트
      if (typeof statusElement !== 'undefined') {
        statusElement.textContent = 'WASM 모듈 준비 완료. 모델을 선택하고 다운로드하세요.';
      }
    },

    print: function(text) {
      console.log('WASM 출력:', text);
    },

    printErr: function(text) {
      console.error('WASM 오류:', text);
    },

    // 파일 시스템 설정
    preRun: [],
    postRun: [],

    // 메모리 설정 (whisper.cpp는 많은 메모리가 필요)
    INITIAL_MEMORY: 64 * 1024 * 1024, // 64MB

    // 오류 처리
    onAbort: function(what) {
      console.error('WASM 모듈이 중단되었습니다:', what);
      if (typeof statusElement !== 'undefined') {
        statusElement.textContent = 'WASM 모듈 오류가 발생했습니다.';
      }
    },

    // 진행률 표시
    monitorRunDependencies: function(left) {
      if (left === 0) {
        console.log('모든 WASM 종속성이 로드되었습니다.');
      } else {
        console.log('WASM 종속성 로드 중:', left, '개 남음');
      }
    }
  };

  // 브라우저 호환성 체크
  function checkBrowserCompatibility() {
    // WASM 지원 확인
    if (typeof WebAssembly === 'undefined') {
      alert('이 브라우저는 WebAssembly를 지원하지 않습니다. Chrome, Firefox, Safari의 최신 버전을 사용하세요.');
      return false;
    }

    // WASM SIMD 지원 확인 (whisper.cpp 필수)
    if (typeof WebAssembly.instantiate !== 'function') {
      console.warn('WASM SIMD가 지원되지 않을 수 있습니다.');
    }

    return true;
  }

  // 페이지 로드 시 호환성 검사
  document.addEventListener('DOMContentLoaded', function() {
    if (!checkBrowserCompatibility()) {
      document.body.innerHTML = '<h1>브라우저 호환성 오류</h1><p>WebAssembly를 지원하는 브라우저가 필요합니다.</p>';
    }
  });
</script>

<script src="downloader.js"></script>
</body>
</html>